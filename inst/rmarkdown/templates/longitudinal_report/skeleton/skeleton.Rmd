---
title: "MAP Longitudinal Report Template"
subtitle: 'Date of Original Request: YYYYMMDD'
author:
- name: '[Omair A. Khan, MAS](omair.a.khan@vumc.org)'
- name: '[Dandan Liu, PhD](dandan.liu@vumc.org)'
date: "Created: YYYYMMDD | Last Modified: `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook:
    code_folding: hide
    theme: lumen
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: yes  
      smooth_scroll: true
---

<style type="text/css">
 #TOC{
   position:fixed;
   top:0;
   // left:0;
   right:0;
   margin: 32px 20px 20px 20px;
   z-index: 9;
   // display:none;
  }
  #toc-toggle{
    position:fixed;
    top:0;
    // left:0;
    right:0;
    margin: 5px 20px 5px 20px;
  }
  .col-md-3{
    width: 0%;
  }
  .col-md-9{
    width: 100%;
  }
  div.container-fluid.main-container{
    max-width:none;
    margin-left:0px;
    margin-right:none;
  }
  div.plot-container{
    margin-left:50px;
    margin-bottom:20px;
  }
  h1.title{
    max-width:950px;
  }
  li.tocify-item{
    text-indent:0px;
  }
  #toc-toggle{
    z-index:9;
  }
  .tocify-subheader, .tocify-item, .tocify, .list-group-item{
  font-size:12pt;
  }
</style>

<button id="toc-toggle" type="button" class="btn btn-default btn-xs code-folding-btn pull-right collapsed" onclick="toggletoc()"><span>Table of Contents (click to hide/show)</span></button>

<script>
function toggletoc(){
$("#TOC").toggle();
}
</script>

```{r setup, echo = TRUE, results = 'hide'}
packages <- as.character(expression(
  knitr,
  rms, 
  Hmisc,
  dplyr,
  magrittr,
  plotly,
  broom,
  purrr,
  formattable,
  DT,
  qtlcharts,
  jtools,
  nlme,
  rVMAP
))

rVMAP::load_pkg(packages)

# set timezone
Sys.setenv(TZ = 'US/Central')

# set seed
set.seed(314159)

# Hmisc options
options(
  prType = 'html', 
  grType = 'plotly',
  digits = 6,
  contrasts = c("contr.treatment", "contr.treatment")
)

# define important directories
## base directories
box.dir  <- file.path("~", "box")
vmac.dir <- file.path(box.dir, "VMAC BIOSTAT")
func.dir <- useful.dir <- file.path(vmac.dir, "Useful Code")
## data directories
data.dir <- file.path(vmac.dir, "DATA", "MAP")
data.merged.dir <- file.path(data.dir, 'mergedData')
## project specific directories
proj.dir <- file.path(vmac.dir, "XXX")
proj.code.dir <- file.path(proj.dir, "code")
proj.data.dir <- file.path(proj.dir, "data")
proj.graphics.dir <- file.path(proj.dir, "graphics")

# define relevant data files
request.date <- 'YYYYMMDD'
# update.request.date <- 'YYYYMMDD'

## to read: merged data
data.merged.file <- file.path(data.merged.dir, 'MAP_bh_d20190625_m20190625.rds')
## to write: project specific file
proj.data.file <- file.path(
  proj.data.dir, 
  paste0("TITLE",
         "_r",
         request.date,
         # "_u",
         # update.request.date,
         "_m",
         format(Sys.time(), '%Y%m%d'),
         ".rds"
  )
)
```

```{r variables}
group.var <- Cs(
  diagnosis.factor.base
)

usable.var <- Cs(
  wml.usable,
  ma.usable,
  freesurfer.2005.usable
)

date.var <- Cs(
  ecogself.date,
  np.date,
  csf.date,
  ma.scan.date,
  wml.scan.date,
  freesurfer.2005.scan.date
)

general.var <- Cs(
  age,
  education,
  sex.factor,
  raceethnicity.factor,
  gds.minus.cog,
  ma.total.intracranial.vol,
  icv,
  apoe4pos.factor,
  cdr.factor.base, # need to create
  cdr.factor.last, # need to create
  cdr.conversion.factor # need to create
)

scd.var <- Cs(
  tot.complaint.gifford.45,
  tot.complaint.gifford.45.mem,
  tot.complaint.gifford.45.ef,
  tot.complaint.gifford.45.lang,
  ecogself.tot
)

np.var <- Cs(
  np.memory.composite,
  np.executive.composite,
  np.moca,
  np.symbol,
  np.digsymb,
  np.hvot,
  np.anim,
  np.tmta.trun
)

wmh.var <- Cs(
  wml.volume,
  wml.volume.left.hemisphere,
  wml.volume.right.hemisphere,
  wml.volume.frontal.lobe,
  wml.volume.parietal.lobe,
  wml.volume.temporal.lobe,
  wml.volume.occipital.lobe
)

ma.var <- Cs(
  ma.grey.matter,
  ma.left.hemisphere,
  ma.right.hemisphere,
  ma.frontal.lobe.vol,
  ma.parietal.lobe.vol,
  ma.temporal.lobe.vol,
  ma.occipital.lobe.vol,
  ma.hippocampus.vol,
  ma.inf.lat.vent.vol
)

AD.sig.var <- Cs(
  AD.sig.schwarz
)

##

outcomes.var <- c(
  np.var,
  wmh.var,
  ma.var,
  AD.sig.var
)

predictors.var <- scd.var

covariates.var <- Cs(
  age,
  education,
  sex.factor,
  raceethnicity.factor,
  apoe4pos.factor,
  diagnosis.factor.base,
  gds.minus.cog
)

covariates.extra.df <- rbind(
  data.frame(
    variable = ma.var,
    covariate = "ma.total.intracranial.vol",
    stringsAsFactors = FALSE
  ),
  data.frame(
    variable = wmh.var,
    covariate = "icv",
    stringsAsFactors = FALSE
  ),
  stringsAsFactors = FALSE
)

###

descriptive.var <- unique(c(
  general.var, 
  scd.var, 
  np.var, 
  wmh.var, 
  ma.var, 
  AD.sig.var
))

all.var.list <- unique(c(
  "map.id",
  "epoch",
  group.var,
  usable.var,
  date.var,
  descriptive.var,
  "cdr.factor"
))
```

```{r functions}
source(file.path(func.dir, 'my.outliers.R'))

print_outliers <- function(outliers.list) {
  outliers.list %>%
    # bind_rows() %>%
    dplyr::mutate(variable = colnames(.)[3]) %>%
    dplyr::rename_at(3, ~"value") %>%
    dplyr::select(variable, map.id, diagnosis.factor.base, value, mean, sd, outlier.in.sd)
}

my.summary <- function(my.descr.var, my.bygrp, my.dat, my.overall = TRUE, my.test = TRUE, ...){
  # modified my.summaryM puts "Combined" first
  my.descr.var = setdiff(my.descr.var, my.bygrp)
  descrForm <- as.formula(paste0(paste(my.descr.var, collapse= " + "),  "~", my.bygrp))
  my.dat <- droplevels(my.dat[rowSums(is.na(my.dat[c(my.descr.var)])) != length(my.descr.var), ])
  
  summary = my.summaryM(descrForm,
                        data       = my.dat,
                        test       = my.test,
                        overall    = my.overall,
                        continuous = 6
  )
  html(summary, exclude1 = FALSE, long = TRUE, prmsd = TRUE, brmsd = TRUE, digits = 3)
}

# Regression Tables

reddify <- formatter("span", style = x ~ ifelse(x < 0.05, "color:red", NA))
```

# Project Summary

## Metadata

- Analytical Request Date: `r paste0(request.date)`
- Study Lead: XXX
- Biostatistician: Omair A. Khan, MAS under Dandan Liu, PhD
- Merged Data File: `r paste0(sub(".*/", "", data.merged.file))`

## Aim

PLACE AIM HERE

# Inclusion/Exclusion Criteria

## Inclusion criteria

- All enrolled MAP participants
- Epoch 1, Epoch 2, Epoch 3, and Epoch 4

```{r inclusion, warning = FALSE, message = FALSE}
merged.df <- readRDS(data.merged.file)

proj.data.df <- merged.df %>%
  select(
    all.var.list[all.var.list %in% names(merged.df)]
  ) %>%
  clear_labels() %>%
  group_by(
    map.id
  ) %>%
  mutate_at(
    c(predictors.var, covariates.var, "ma.total.intracranial.vol", "icv"),
    ~ dplyr::first(.)
  ) %>%
  mutate_at(
    date.var,
    list(diff.yr = as.numeric(. - dplyr::first(.)) / 365.25)
  ) %>%
  rename_at(
    vars(contains("_")),
    funs(gsub("\\_", "\\.", .))
  ) %>%
  ungroup() %>%
  as.data.frame()

labels.df <- bind_rows(
  tibble(
    variable = grep("factor", all.var.list, v = T),
    label = purrr::map_chr(gsub(".factor|.base", "", grep("factor", all.var.list, v = T)), function(x) Hmisc::label(merged.df[[x]]))
  ),
  tibble(
    variable = grep("factor", all.var.list, v = T, invert = T),
    label = purrr::map_chr(grep("factor", all.var.list, v = T, invert = T), function(x) Hmisc::label(merged.df[[x]]))
  )
)

for (var.i in labels.df$variable[labels.df$variable %in% names(proj.data.df)]) {
  Hmisc::label(proj.data.df[, var.i]) <- pull(labels.df[labels.df$variable == var.i, "label"])
}

# set unusable variables to NA
proj.data.df[proj.data.df$wml.usable %in% 0, wmh.var] <- NA
proj.data.df[proj.data.df$ma.usable %in% 0, ma.var] <- NA
proj.data.df[proj.data.df$freesurfer.2005.usable %in% 0, AD.sig.var] <- NA

mydat0.long <- proj.data.df

class(mydat0.long) <- "data.frame"
```

## Exclusion criteria

- Participants diagnosed with dementia
- Pariticpants with all outcomes missing
- Participants with any covariates missing

```{r exclusion, warning = FALSE, message = FALSE}
mydat.long <- exclude_participants(
  map_id = NULL,
  usable = NULL,
  diagnosis = c("Dementia"),
  predictors = predictors.var, 
  outcomes = outcomes.var, 
  covariates = covariates.var,
  data = mydat0.long, 
  data_type = "l"
)

mydat.label.temp <- label(mydat.long)

mydat.long <- droplevels(mydat.long)

label(mydat.long) = lapply(names(mydat.label.temp), function(x) label(mydat.long[, x]) = mydat.label.temp[x])

mydat <- droplevels(mydat.long[mydat.long$epoch == 1, ])

label(mydat) = lapply(names(mydat.label.temp), function(x) label(mydat[, x]) = mydat.label.temp[x])
```

```{r make-annual-change, warning = FALSE, error = FALSE, message = FALSE}
annual_change.df <- mydat.long %>%
  dplyr::select(
    map.id, diagnosis.factor.base, np.date.diff.yr, wml.scan.date.diff.yr, ma.scan.date.diff.yr, freesurfer.2005.scan.date.diff.yr, np.var, wmh.var, ma.var, AD.sig.var
  ) %>%
  reshape2::melt(
    data = .,
    id.vars = c("map.id", "diagnosis.factor.base",
                "np.date.diff.yr", "wml.scan.date.diff.yr", "ma.scan.date.diff.yr", "freesurfer.2005.scan.date.diff.yr"),
    measure.vars = c(np.var, wmh.var, ma.var, AD.sig.var),
    na.rm = TRUE
  ) %>%
  dplyr::as_tibble() %>%
  dplyr::mutate(
    follow.up.diff.yr = case_when(
      variable %in% np.var ~ np.date.diff.yr,
      variable %in% wmh.var ~ wml.scan.date.diff.yr,
      variable %in% ma.var ~ ma.scan.date.diff.yr,
      variable %in% AD.sig.var ~ freesurfer.2005.scan.date.diff.yr
    )
  ) %>%
  dplyr::select(
    -c("np.date.diff.yr", "wml.scan.date.diff.yr", "ma.scan.date.diff.yr", "freesurfer.2005.scan.date.diff.yr")
  ) %>%
  group_by(map.id, variable) %>%
  dplyr::filter(
    n() > 1
  ) %>%
  ungroup() %>%
  na.omit() %>%
  tidyr::nest(
    -c(map.id, diagnosis.factor.base, variable)
  ) %>%
  dplyr::mutate( 
    fit = purrr::map(data, ~ lm(value ~ follow.up.diff.yr, data = .x)),
    tidied = purrr::map(fit, broom::tidy)
  ) %>%
  tidyr::unnest( 
    tidied, .drop = TRUE
  ) %>%
  dplyr::filter(
    term == "follow.up.diff.yr"
  ) %>%
  dplyr::select(
    map.id, diagnosis.factor.base, variable, estimate
  ) %>%
  dplyr::group_by(
    variable
  ) %>%
  reshape2::dcast(
    ., 
    map.id + diagnosis.factor.base ~ variable
  )
```

## Data Processing Summary

Click "&oplus;" to see a list of the included and excluded participants at each step.

```{r}
datatable(
  cbind(' ' = '&oplus;', flow_chart.df), 
  escape = -2,
  extensions = c('Buttons'),
  options = list(
    dom = 'Btip',
    buttons = c('copy', 'csv'),
    pageLength = dim(flow_chart.df)[1],
    columnDefs = list(
      list(visible = FALSE, targets = c(11:18)),
      list(orderable = FALSE, className = 'details-control', targets = 1)
    )
  ),
  callback = JS("
                  table.column(1).nodes().to$().css({cursor: 'pointer'});
                  var format = function(d) {
                  return '<div style=\"background-color:#eee; padding: .5em;\"> Participants Excluded in this Step (Epoch 1): ' +
d[15] + 
'<br /><br /> Participants Excluded in this Step (Epoch 2): ' + 
d[16] + 
'<br /><br /> Participants Excluded in this Step (Epoch 3): ' + 
d[17] + 
'<br /><br /> Participants Excluded in this Step (Epoch 4): ' + 
d[18] + 
'<br /><br /> Participants Included in this Step (Epoch 1): ' +
d[11] + 
'<br /><br /> Participants Included in this Step (Epoch 2): ' + 
d[12] + 
'<br /><br /> Participants Included in this Step (Epoch 3): ' + 
d[13] + 
'<br /><br /> Participants Included in this Step (Epoch 4): ' + 
d[14] + 
'</div>';
                  };
                  table.on('click', 'td.details-control', function() {
                  var td = $(this), row = table.row(td.closest('tr'));
                  if (row.child.isShown()) {
                  row.child.hide();
                  td.html('&oplus;');
                  } else {
                  row.child(format(row.data())).show();
                  td.html('&CircleMinus;');
                  }
                  });"
  ))
```

## Summary of Missing Data in Outcomes

Click "&oplus;" to see the participants with missing outcomes by epoch.

```{r}
missing_outcomes.df <- tibble(
  outcome = outcomes.var,
  N = NA_integer_,
  Nobs = NA_integer_,
  e1 = NA_character_,
  e2 = NA_character_,
  e3 = NA_character_,
  e4 = NA_character_
)

for (i in outcomes.var) {
  temp <- mydat.long[is.na(mydat.long[[i]]), c("map.id", "epoch")] %>% arrange(epoch, map.id) 
  
  N = as.integer(length(unique(temp[["map.id"]])))
  Nobs = as.integer(dim(temp)[1])
  e1 = temp %>% filter(epoch == 1) %>% pull(map.id) %>% paste(., collapse = ", ")
  e2 = temp %>% filter(epoch == 2) %>% pull(map.id) %>% paste(., collapse = ", ")
  e3 = temp %>% filter(epoch == 3) %>% pull(map.id) %>% paste(., collapse = ", ")
  e4 = temp %>% filter(epoch == 4) %>% pull(map.id) %>% paste(., collapse = ", ")
  
  missing_outcomes.df[missing_outcomes.df$outcome == i, c("N", "Nobs", "e1", "e2", "e3", "e4")] <- c(N, Nobs, e1, e2, e3, e4)
}
```

```{r}
datatable(
  cbind(' ' = '&oplus;', missing_outcomes.df), 
  escape = -2,
  extensions = c('Buttons'),
  colnames = c(' ', 'Outcome', 'Participants with Missing Outcome', 'Total Observations with Missing Outcome', 'Epoch 1', 'Epoch 2', 'Epoch 3', 'Epoch 4'),
  options = list(
    dom = 'Btip',
    buttons = c('copy', 'csv'),
    pageLength = dim(missing_outcomes.df)[1],
    columnDefs = list(
      list(visible = FALSE, targets = c(5, 6, 7, 8)),
      list(orderable = FALSE, className = 'details-control', targets = 1)
    )
  ),
  callback = JS("
                  table.column(1).nodes().to$().css({cursor: 'pointer'});
                  var format = function(d) {
                  return '<div style=\"background-color:#eee; padding: .5em;\"> Participants With Missing Outcome in Epoch 1: ' +
                  d[5] + '<br /><br /> Participants With Missing Outcome in Epoch 2: ' + d[6] + '<br /><br /> Participants With Missing Outcome in Epoch 3: ' + d[7] + '<br /><br /> Participants With Missing Outcome in Epoch 4: ' + d[8] + '</div>';
                  };
                  table.on('click', 'td.details-control', function() {
                  var td = $(this), row = table.row(td.closest('tr'));
                  if (row.child.isShown()) {
                  row.child.hide();
                  td.html('&oplus;');
                  } else {
                  row.child(format(row.data())).show();
                  td.html('&CircleMinus;');
                  }
                  });"
  ))
```

# Sensitivity Analysis Preparation: Excluding Outliers using Values > 4 SD

## Cross-Sectional

The following observations are excluded from the baseline data set for this sensitivity analysis:

```{r}
mydat.nolabels <- clear_labels(mydat)
var.outlier <- c(predictors.var, outcomes.var)
var.outlier.cont <- var.outlier[sapply(mydat.nolabels[, var.outlier], function(x) any(class(x) %in% c("numeric", "integer")))]
outliers <- my.outliers(mydat.nolabels, var = var.outlier.cont, oth.var = c("diagnosis.factor.base"))

mydat.sens.outlier <- outliers[['data']]

outliers.df <- outliers[["outliers"]] %>% 
  purrr::map(print_outliers) %>% 
  bind_rows() %>%
  rowwise() %>%
  mutate(
    label = label(mydat[, variable]),
    variable = factor(.data$variable, levels = var.outlier.cont)
  ) %>%
  select(
    label, everything()
  )

outliers.df %>% 
  datatable(
    rownames = FALSE,
    colnames = c("Variable Label", "Variable Name", "MAP ID", "Baseline Diagnosis", "Value", "Mean", "SD", "Outlier in SD"),
    caption = "Outliers (> 4 SD) excluded from secondary analysis") %>%
  formatSignif(5:8, 4)
```

## Longitudinal

The following observations are excluded from the longitudinal data set for this sensitivity analysis:

```{r}
mydat.long.nolabels <- clear_labels(mydat.long)

var.outlier <- c(predictors.var, outcomes.var)
var.outlier.cont <- var.outlier[sapply(mydat.long.nolabels[, var.outlier], function(x) any(class(x) %in% c("numeric", "integer")))]

outliers.e1 <- my.outliers(mydat.long.nolabels[mydat.long.nolabels$epoch == 1, ], var = var.outlier.cont, oth.var = c("diagnosis.factor.base"))
outliers.e2 <- my.outliers(mydat.long.nolabels[mydat.long.nolabels$epoch == 2, ], var = var.outlier.cont, oth.var = c("diagnosis.factor.base"))
outliers.e3 <- my.outliers(mydat.long.nolabels[mydat.long.nolabels$epoch == 3, ], var = var.outlier.cont, oth.var = c("diagnosis.factor.base"))
outliers.e4 <- my.outliers(mydat.long.nolabels[mydat.long.nolabels$epoch == 4, ], var = var.outlier.cont, oth.var = c("diagnosis.factor.base"))

mydat.long.sens.outlier <- mydat.long

mydat.long.sens.outlier[mydat.long.sens.outlier$epoch == 1, ] <- outliers.e1[['data']]
mydat.long.sens.outlier[mydat.long.sens.outlier$epoch == 2, ] <- outliers.e2[['data']]
mydat.long.sens.outlier[mydat.long.sens.outlier$epoch == 3, ] <- outliers.e3[['data']]
mydat.long.sens.outlier[mydat.long.sens.outlier$epoch == 4, ] <- outliers.e4[['data']]

outliers.e1.df <- outliers.e1[["outliers"]] %>% 
  purrr::map(print_outliers) %>% 
  bind_rows() %>%
  rowwise() %>%
  mutate(
    label = label(mydat[, variable]),
    variable = factor(.data$variable, levels = var.outlier.cont),
    epoch = 1
  ) %>%
  select(
    epoch, label, everything()
  )

outliers.e2.df <- outliers.e2[["outliers"]] %>% 
  purrr::map(print_outliers) %>% 
  bind_rows() %>%
  rowwise() %>%
  mutate(
    label = label(mydat[, variable]),
    variable = factor(.data$variable, levels = var.outlier.cont),
    epoch = 2
  ) %>%
  select(
    epoch, label, everything()
  )

outliers.e3.df <- outliers.e3[["outliers"]] %>% 
  purrr::map(print_outliers) %>% 
  bind_rows() %>%
  rowwise() %>%
  mutate(
    label = label(mydat[, variable]),
    variable = factor(.data$variable, levels = var.outlier.cont),
    epoch = 3
  ) %>%
  select(
    epoch, label, everything()
  )

outliers.e4.df <- outliers.e4[["outliers"]] %>% 
  purrr::map(print_outliers) %>% 
  bind_rows() %>%
  rowwise() %>%
  mutate(
    label = label(mydat[, variable]),
    variable = factor(.data$variable, levels = var.outlier.cont),
    epoch = 4
  ) %>%
  select(
    epoch, label, everything()
  )

outliers.long.df <- rbind(outliers.e1.df, outliers.e2.df)
outliers.long.df <- rbind(outliers.long.df, outliers.e3.df)
outliers.long.df <- rbind(outliers.long.df, outliers.e4.df)

outliers.long.df %>% 
  datatable(
    rownames = FALSE,
    colnames = c("Epoch", "Variable Label", "Variable Name", "MAP ID", "Baseline Diagnosis", "Value", "Mean", "SD", "Outlier in SD"),
    caption = "Outliers (> 4 SD) excluded from secondary analysis") %>%
  formatSignif(5:9, 4)
```

## Sensitivity Analysis: Excluding CVD and AFib

The following participants are excluded from the baseline and longitudinal data sets for this sensitivity analysis:

```{r}
mydat.sens.cvd.afib <- mydat %>%
  filter(
    cvd.factor == "No"
  ) %>%
  filter(
    afib.factor == "No"
  )

mydat.long.sens.cvd.afib <- mydat.long %>%
  filter(
    map.id %in% mydat.sens.cvd.afib$map.id
  )

cvd.afib.df <- mydat %>%
  filter(
    cvd.factor == "Yes" | afib.factor == "Yes"
  ) %>%
  select(
    map.id, diagnosis.factor.base, cvd.factor, afib.factor
  )

cvd.afib.df %>% 
  datatable(
    rownames = FALSE,
    colnames = c("MAP ID", "Baseline Diagnosis", "CVD", "AFib"),
    caption = "Participants with CVD and/or AFib excluded from secondary analysis"
  )
```

# Descriptive Statistics

## Baseline Variables

```{r describe-overall, warning = FALSE, message = FALSE}
d.all <- describe(mydat[, descriptive.var], descript = "Data Summary")
Hmisc::html(d.all)
```

## Baseline Variables: Summaries and Comparisons by Baseline Diagnosis

```{r describe-dx-baseline, results = 'asis', warning = FALSE, message = FALSE}
my.summary(my.descr.var = descriptive.var,
           my.bygrp = group.var[1],
           my.bygrp.lab = "Baseline Diagnosis",
           my.dat = mydat,
           my.overall = TRUE)
```

## Annual Change (OLS-calculated): Summaries and Comparisons by Baseline Diagnosis

Note: This calculation excludes all participants with only one observation per variable in the longitudinal data set.

```{r describe-dx-annual, results = 'asis', warning = FALSE, message = FALSE}
my.summary(my.descr.var = continuous.var,
           my.bygrp = group.var[1],
           my.bygrp.lab = "Baseline Diagnosis",
           my.dat = annual_change.df,
           my.overall = TRUE)
```

## Maximum Follow Up Time (Years): Summaries and Comparisons by Baseline Diagnosis

Note: This calculation excludes all participants with only one observation per variable in the longitudinal data set.

```{r, results = 'asis', warning = FALSE, message = FALSE}
follow_up.df <- mydat.long %>%
  clear_labels() %>%
  arrange(
    map.id, epoch
  ) %>%
  select(
    c("map.id", date.diff.yr.var)
  ) %>%
  group_by(
    map.id
  ) %>%
  tidyr::gather(
    "date_type", "follow_up", -map.id
  ) %>%
  ungroup() %>%
  na.omit() %>%
  group_by(
    map.id, date_type
  ) %>%
  filter(
    n() > 1
  ) %>%
  filter(
    follow_up == max(follow_up, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  distinct() %>%
  group_by(map.id, date_type) %>%
  tidyr::spread(
    date_type, follow_up
  ) %>%
  ungroup() %>%
  left_join(
    clear_labels(mydat[, c("map.id", "diagnosis.factor.base")]),
    by = "map.id"
  ) %>%
  as.data.frame()

my.summary(my.descr.var = date.diff.yr.var[date.diff.yr.var %in% names(follow_up.df)],
           my.bygrp = group.var[1],
           my.bygrp.lab = "Baseline Diagnosis",
           my.dat = follow_up.df,
           my.overall = TRUE)
```

# Baseline Descriptive Plots

## Histograms

### Categorical Variables

```{r, fig.width = 8, fig.height = 5, warning = FALSE, message = FALSE}
clear_labels(mydat) %>%
  select(
    one_of(
      descriptive.var[sapply(mydat[, descriptive.var], function(x) !any(class(x) %in% c("numeric", "integer")))]
    )
  ) %>%
  tidyr::gather(key = variable, value = value) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(x = value)) +
  geom_bar() +
  facet_wrap(~ variable, ncol = 3, scales = "free") +
  labs(x = "", y = "")
```

### Continuous Variables

```{r, fig.width = 8, fig.height = 20, warning = FALSE, message = FALSE}
clear_labels(mydat) %>%
  select(
    one_of(
      descriptive.var[sapply(mydat[, descriptive.var], function(x) any(class(x) %in% c("numeric", "integer")))]
    )
  ) %>%
  tidyr::gather(key = variable, value = value) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30) +
  facet_wrap(~ variable, ncol = 3, scales = "free") +
  labs(x = "", y = "")
```

## Scatterplots

### tot.complaint.gifford.45

```{r, fig.width = 8, fig.height = 25, warning = FALSE, message = FALSE}
clear_labels(mydat) %>%
  select(
    one_of(
      grep("factor", descriptive.var, v = T, invert = T)
    )
  ) %>%
  tidyr::gather(key = variable, value = value, -tot.complaint.gifford.45) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(x = tot.complaint.gifford.45, y = value)) +
  geom_point() +
  geom_smooth(method = lm) +
  facet_wrap(~ variable, ncol = 3, scales = "free")
```

# Baseline Spearman Correlations

```{r spcor.all}
scatter.var.A <- descriptive.var
scatter.var.B <- scd.var

cor.all.df <- NULL
for (j in 1:length(scatter.var.B)){
  for (i in 1:length(scatter.var.A)){
    temp.df <- mydat[, c(scatter.var.A[i], scatter.var.B[j])]
    temp.df <- sapply(temp.df, as.numeric)
    x <- Hmisc::rcorr(temp.df, type = "spearman")
    cor.all.df <- rbind(cor.all.df, c(scatter.var.A[i],
                                      scatter.var.B[j],
                                      x[["r"]][1,2],
                                      x[["P"]][1,2],
                                      x[["n"]][1,2]))
  }
}

cor.all.df <- as.data.frame(cor.all.df, stringsAsFactors = FALSE)
```

```{r spcor.nc}
cor.nc.df <- NULL
for (j in 1:length(scatter.var.B)){
  for (i in 1:length(scatter.var.A)){
    temp.df <- mydat[mydat$diagnosis.factor.base == "Normal", c(scatter.var.A[i], scatter.var.B[j])]
    temp.df <- sapply(temp.df, as.numeric)
    x <- Hmisc::rcorr(temp.df, type = "spearman")
    cor.nc.df <- rbind(cor.nc.df, c(scatter.var.A[i],
                                    scatter.var.B[j],
                                    x[["r"]][1,2],
                                    x[["P"]][1,2],
                                    x[["n"]][1,2]))
  }
}

cor.nc.df <- as.data.frame(cor.nc.df, stringsAsFactors = FALSE)
```

```{r spcor.aar}
cor.aar.df <- NULL
for (j in 1:length(scatter.var.B)){
  for (i in 1:length(scatter.var.A)){
    temp.df <- mydat[mydat$diagnosis.factor.base == "Ambiguous At Risk", c(scatter.var.A[i], scatter.var.B[j])]
    temp.df <- sapply(temp.df, as.numeric)
    x <- Hmisc::rcorr(temp.df, type = "spearman")
    cor.aar.df <- rbind(cor.aar.df, c(scatter.var.A[i],
                                    scatter.var.B[j],
                                    x[["r"]][1,2],
                                    x[["P"]][1,2],
                                    x[["n"]][1,2]))
  }
}

cor.aar.df <- as.data.frame(cor.aar.df, stringsAsFactors = FALSE)
```

```{r spcor.mci}
cor.mci.df <- NULL
for (j in 1:length(scatter.var.B)){
  for (i in 1:length(scatter.var.A)){
    temp.df <- mydat[mydat$diagnosis.factor.base == "MCI", c(scatter.var.A[i], scatter.var.B[j])]
    temp.df <- sapply(temp.df, as.numeric)
    x <- Hmisc::rcorr(temp.df, type = "spearman")
    cor.mci.df <- rbind(cor.mci.df, c(scatter.var.A[i],
                                      scatter.var.B[j],
                                      x[["r"]][1,2],
                                      x[["P"]][1,2],
                                      x[["n"]][1,2]))
  }
}

cor.mci.df <- as.data.frame(cor.mci.df, stringsAsFactors = FALSE)
```

```{r spcor.combined}
cor.df <- data.frame(
  IV = cor.all.df$V1,
  DV = cor.all.df$V2,
  all.cor = cor.all.df$V3,
  all.p = cor.all.df$V4,
  all.n = cor.all.df$V5,
  nc.cor = cor.nc.df$V3,
  nc.p = cor.nc.df$V4,
  nc.n = cor.nc.df$V5,
  aar.cor = cor.aar.df$V3,
  aar.p = cor.aar.df$V4,
  aar.n = cor.aar.df$V5,  
  mci.cor = cor.mci.df$V3,
  mci.p = cor.mci.df$V4,
  mci.n = cor.mci.df$V5,
  stringsAsFactors = FALSE
)
```

```{r spcorDT, results = 'asis'}
sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Independent Variable'),
      th(rowspan = 2, 'Dependent Variable'),
      th(colspan = 3, 'Overall'),
      th(colspan = 3, 'Normal'),
      th(colspan = 3, 'Ambiguous At Risk'),
      th(colspan = 3, 'MCI')
    ),
    tr(
      lapply(rep(c('r', 'p', 'N'), 4), th)
    )
  )
))

datatable(
  cor.df,
  rownames = FALSE,
  container = sketch,
  extensions = c('Buttons', 'FixedColumns'),
  options = list(
    dom = 'Bfrtip',
    pageLength = dim(cor.df)[1] / length(scatter.var.B),
    buttons = c('copy', 'csv'),
    scrollX = TRUE,
    fixedColumns = list(leftColumns = 2)
  )
) %>%
  formatStyle(
    c('all.p', 'nc.p', 'aar.p', 'mci.p'),
    color = styleInterval(0.05, c('red', 'normal'))
  ) %>%
  formatRound(c('all.cor', 'nc.cor', 'aar.cor', 'mci.cor'), 3) %>%
  formatRound(c('all.p', 'nc.p', 'aar.p', 'mci.p'), 4)
```

## Correlation Matrix with Scatter Plots

The linked plot below shows a heatmap of the correlation values on the left and the corresponding scatterplot on the right.

**Correlation matrix**

* Colors
    + red: positive correlation
    + white: no correlation
    + blue: negative correlation

* Interactivity
    + hover: displays Spearman correlation between the two variables (*r*)
    + click: displays scatterplot of the two variables

**Scatterplot**

* Colors
    + blue: "Normal"
    + magenta: "Ambiguous At Risk"
    + orange: "MCI"

* Interactivity
    + hover: displays corresponding MAP ID

```{r, message = FALSE, warning = FALSE, fig.height = 4.5, fig.width = 10}
mydat.cor <- mydat[, descriptive.var] %>% data.matrix()
mydat.cor <- as.data.frame(mydat.cor)
rownames(mydat.cor) <- mydat$map.id

spearman <- cor(mydat.cor, use = "pairwise.complete.obs", method = "spearman")

qtlcharts::iplotCorr(
  mydat.cor, group = mydat$diagnosis.factor.base, corr = spearman,
  chartOpts = list(cortitle = "Correlation Matrix",
                   scattitle = "Scatter Plot",
                   scatcolors = c("blue", "magenta", "orange")
  ))
```

# Correlations across Epochs for Outcomes

Correlation between epochs decreases over time for cognitive variables but is relatively stable for brain MRI variables. Therefore, for the within-subject correlation matrices for the longitudinal analyses, we will use a continuous autoregressive process covariate structure for cognitive outcomes and compound symmetry covariance structure for brain MRI outcomes.

```{r}
epoch1 <- mydat.long[mydat.long$epoch == 1, c('map.id', outcomes.var)]
epoch2 <- mydat.long[mydat.long$epoch == 2, c('map.id', outcomes.var)]
epoch3 <- mydat.long[mydat.long$epoch == 3, c('map.id', outcomes.var)]
epoch4 <- mydat.long[mydat.long$epoch == 4, c('map.id', outcomes.var)]

cor.mat <- matrix(0, nrow = length(outcomes.var), ncol = 6)

for(i in seq_along(outcomes.var)){
  oname<-outcomes.var[i]
  
  date.diff.var <- case_when(
    oname %in% np.var ~ "np.date.diff.yr",
    oname %in% wmh.var ~ "wml.scan.date.diff.yr",
    oname %in% ma.var ~ "ma.scan.date.diff.yr",
    oname %in% AD.sig.var ~ "freesurfer.2005.scan.date.diff.yr"
  )
  
  dat.sub <- na.omit(mydat.long[, c('map.id', 'epoch', date.diff.var, oname)])
  fit <- ols(as.formula(paste0(oname, ' ~ ', date.diff.var)), data = dat.sub, x = TRUE)

  res.mat0 <- cbind(dat.sub[, c('map.id', 'epoch')], 'res' = fit$residuals)
  res.mat <- reshape(data = res.mat0,
                     direction = "wide",
                     v.names = "res",
                     timevar = "epoch",
                     idvar = "map.id"
  )
  if ("res.2" %nin% names(res.mat)) {
    res.mat <- cbind(res.mat, res.2 = NA)
    }
  
  if ("res.3" %nin% names(res.mat)) {
    res.mat <- cbind(res.mat, res.3 = NA)
  }
  
  if ("res.4" %nin% names(res.mat)) {
    res.mat <- cbind(res.mat, res.4 = NA)
  }
  
  my.cor <- cor(res.mat[, c('res.1', 'res.2', 'res.3', 'res.4')], use = "pairwise.complete.obs")
  cor.mat[i,] <- round(c(my.cor[1, 2], my.cor[2, 3], my.cor[3, 4], my.cor[1, 3], my.cor[1, 4], my.cor[2, 4]), 2)
}

cor.df <- cor.mat
rownames(cor.df) <- outcomes.var
colnames(cor.df) <- c("Epoch 1 vs 2", "Epoch 2 vs 3", "Epoch 3 vs 4", "Epoch 1 vs 3", "Epoch 1 vs 4", "Epoch 2 vs 4")

datatable(
  cor.df,
  rownames = TRUE,
  extensions = c('Buttons', 'FixedColumns'),
  options = list(
    dom = 'Bfrtip',
    pageLength = length(outcomes.var),
    buttons = c('copy', 'csv'),
    scrollX = TRUE #,
    #fixedColumns = list(leftColumns = 2)
  )
)
```

<!-- Regression -->

```{r long.ModelPlus.fun}
ModelPlus <- function(dat, predictor, outcome, covariates, mod, pcutoff = 0.05, show = TRUE, excl = FALSE, useRcs = FALSE, remove = FALSE) {
  dat.subset <- dat
  
  date.diff.var <- case_when(
    outcome %in% np.var ~ "np.date.diff.yr",
    outcome %in% wmh.var ~ "wml.scan.date.diff.yr",
    outcome %in% ma.var ~ "ma.scan.date.diff.yr",
    outcome %in% AD.sig.var ~ "freesurfer.2005.scan.date.diff.yr"
  )
  
  dat.subset <- na.omit(dat.subset[, unique(c(predictor, outcome, covariates, 'map.id', date.diff.var))])
  
  dat.subset <- droplevels(dat.subset)

  N <- dim(dat.subset)[1]

  # set "No" to reference level
  if (nlevels(dat.subset$apoe4pos.factor) > 1) {
    dat.subset$apoe4pos.factor <- relevel(dat.subset$apoe4pos.factor, ref = "No")
  }

  dd <<- datadist(dat.subset, adjto.cat = "first")
  options(datadist = 'dd')

  ### create regression formula ###

  predphrase <- paste0(predictor, '*', date.diff.var)
  
  ## formula string for basic regressions
  form.string <- paste0(outcome, ' ~ ', paste0(c(covariates, predphrase), collapse= ' + '))

  ## formula string for interactions
  if (grepl('inter.dx', mod)) {
    form.string <- paste0(form.string, ' + ', predphrase, ' : ', 'diagnosis.factor.base')
  }
  if (grepl('inter.apoe', mod)) {
    form.string <- paste0(form.string, ' + ', predphrase, ' : ', 'apoe4pos.factor')
  }
  if (grepl('inter.sex', mod)) {
    form.string <- paste0(form.string, ' + ', predphrase, ' : ', 'sex.factor')
  }  

  form <- as.formula(form.string)

  ######
  
  ctrl <- lmeControl(opt = 'optim')
  
  if (outcome %in% c(np.var)) {
    fit <- lme(form, data = dat.subset, na.action = na.omit, random = ~ 1 + np.date.diff.yr|map.id, correlation = corCAR1(form = ~ np.date.diff.yr|map.id), control = ctrl)
  } else if (outcome %in% wmh.var) {
    fit <- lme(form, data = dat.subset, na.action = na.omit, random = ~ 1 + wml.scan.date.diff.yr|map.id, correlation = corCompSymm(form = ~ wml.scan.date.diff.yr|map.id), control = ctrl)
  } else if (outcome %in% ma.var) {
    fit <- lme(form, data = dat.subset, na.action = na.omit, random = ~ 1 + ma.scan.date.diff.yr|map.id, correlation = corCompSymm(form = ~ ma.scan.date.diff.yr|map.id), control = ctrl)
  } else if (outcome %in% AD.sig.var) {
    fit <- lme(form, data = dat.subset, na.action = na.omit, random = ~ 1 + freesurfer.2005.scan.date.diff.yr|map.id, correlation = corCompSymm(form = ~ freesurfer.2005.scan.date.diff.yr|map.id), control = ctrl)
  }
  
  junk <- coef(summary(fit))
  coefs <- junk[, 'Value']
  ses <- junk[, 'Std.Error']
  df <- junk[, 'DF']
  lls <- coefs - qt(0.975, df)*ses
  uls <- coefs + qt(0.975, df)*ses
  pvals <- junk[, 'p-value']
  N <- fit$dims$ngrps[1]  

  Nobs <- fit$dims$N
  
  cis.f <- paste0(
    "(",
    format(lls, digits = 4, nsmall = 3), ", ",
    format(uls, digits = 4, nsmall = 3), ")"
  )

  pvals.f <- formatC(pvals, digits = 4, format = "f")
  rowsToKeep <- 2:length(coefs)

  sumtable <- cbind(
    format(coefs, digits = 4, nsmall = 2, scientific = FALSE), 
    format(lls, digits = 4, nsmall = 3), 
    format(uls, digits = 4, nsmall = 3), 
    pvals.f
  )[rowsToKeep, ]
  
  colnames(sumtable) <- Cs(Coef, LCI, UCI, Pval)

  predCapPhrase <- ifelse(useRcs, ', with nonlinear term (restricted cubic spline with 3 knots)', ' as a single linear term')

  table.cap.1 <- paste0(
    'Predictor: ', predphrase, predCapPhrase,
    '; Outcome: ', outcome,
    '; N: ', N,
    '.'
  )

  # format output

  table.rownames <- names(coefs)[rowsToKeep]

  table.rownames[table.rownames == "apoe4pos.factor=Yes"] <- "ApoE4 pos. (vs. neg.)"
  table.rownames[table.rownames == "education"] <- "Education (yrs)"
  table.rownames[table.rownames == "sex.factor=Female"] <- "Female (vs. male)"
  table.rownames[table.rownames == "diagnosis.factor.base=MCI"] <- "MCI (vs. NC)"
  table.rownames[table.rownames == "diagnosis.factor.base=Ambiguous At Risk"] <- "At Risk (vs. NC)"
  table.rownames <- gsub('diagnosis.factor.base', 'diagnosis', table.rownames)
  table.rownames <- gsub('apoe4pos.factor', 'apoe4pos', table.rownames)
  table.rownames <- gsub('amyloidPos.factor.base', 'amyloidPos', table.rownames)

  table.cellTex <- ifelse(as.numeric(sumtable[, "Pval"]) < pcutoff, "TRUE", "FALSE")
  table.colorPhrase <- paste0('P-values less than ', pcutoff, ' are in red.')
  total.p <- pvals[length(pvals)]

  table.cap <- paste(table.cap.1, table.colorPhrase)

  if (excl) table.cap <- paste0("Excluding Outliers: ", table.cap)
  # if (remove) table.cap <- paste0("Excluding Outliers: ", table.cap)

  # print output

  if (show) {
    sumtable.format <- sumtable %>%
      as.data.frame(., stringsAsFactors = FALSE) %>%
      formattable(list(Pval = rVMAP::format_p), caption = table.cap, full_width = F)
    print(sumtable.format)
    cat("\n\n")
  }

  list(fit = fit, sumtable = sumtable, dd = dd, total.p = total.p, N = N, Nobs = Nobs)
}
```

```{r long.my.section.fun, results = 'asis'}
my.section <- function(my.pred, my.outcomes, my.covariates, my.mod, my.mod.text, 
                       dat = mydat.long, dat2 = mydat.long.sens.outlier, dat3 = mydat.long.sens.cvd.afib) {

  my.mod.sens.outlier <- paste0(my.mod, ".sens.outlier")
  my.mod.sens.cvd.afib <- paste0(my.mod, ".sens.cvd.afib")

  my.show.out <- !grepl('factor', my.outcomes)
  
  my.mod.all <- c(my.mod, my.mod.sens.outlier, my.mod.sens.cvd.afib)
  
  # create list to store models and name it #
  htList <- vector("list", length(my.mod.all))
  names(htList) <- my.mod.all
  
  for(i in seq_along(my.mod.all)){
    htList[[i]] <- vector("list", length(my.outcomes))
    names(htList[[i]]) <- my.outcomes
  }
  
  for(i in seq_along(my.outcomes)){
    vname <- my.outcomes[i]  # define the current outcome of interest #

    cat(paste0("\n## Outcome: ", vname, " {.tabset .tabset-fade .tabset-pills} \n"))
    
    for (j in seq_along(my.mod)){
      
      ### model level ###
      
      m.covs <- my.covariates  # define model covariates #
      
      adj.cov <- NULL
      
      if (vname %in% covariates.extra.df$variable) {
        adj.cov <- covariates.extra.df[covariates.extra.df$variable %in% vname, "covariate"]
        m.covs <- c(m.covs, adj.cov)
      }
      
      m  <- my.mod[j]
      m2 <- my.mod.sens.outlier[j]
      m3 <- my.mod.sens.cvd.afib[j]
      
      m.text <- my.mod.text[j] # j = model #
      # m.show <- my.show.out[i] # i = outcome #
      
      m.dat <- dat
      m.dat2 <- dat2
      m.dat3 <- dat3
      
      ### subset data based on model type ###
      
      if (grepl('main', m)){
        m.dat <- dat
        m.dat2 <- dat2
        m.dat3 <- dat3
      }
      
      if (grepl('inter.dx', m)){
        m.dat <- subset(dat, diagnosis.factor.base %in% c("Normal", "MCI"))
        m.dat2 <- subset(dat2, diagnosis.factor.base %in% c("Normal", "MCI"))
        m.dat3 <- subset(dat3, diagnosis.factor.base %in% c("Normal", "MCI"))
      }
      
      if (grepl("sub.nc", m)){
        m.covs <- setdiff(m.covs, "diagnosis.factor.base")
        m.dat <- subset(dat, diagnosis.factor.base == "Normal")
        m.dat2 <- subset(dat2, diagnosis.factor.base == "Normal")
        m.dat3 <- subset(dat3, diagnosis.factor.base == "Normal")
      }
      
      if(grepl("sub.mci", m)){
        m.covs <- setdiff(m.covs, "diagnosis.factor.base")
        m.dat <- subset(dat, diagnosis.factor.base == "MCI")
        m.dat2 <- subset(dat2, diagnosis.factor.base == "MCI")
        m.dat3 <- subset(dat3, diagnosis.factor.base == "MCI")
      }
      
      if(grepl("sub.apoe.yes", m)){
        m.covs <- setdiff(m.covs, "apoe4pos.factor")
        m.dat <- subset(dat, apoe4pos.factor == "Yes")
        m.dat2 <- subset(dat2, apoe4pos.factor == "Yes")
        m.dat3 <- subset(dat3, apoe4pos.factor == "Yes")
      }
      
      if(grepl("sub.apoe.no", m)){
        m.covs <- setdiff(m.covs, "apoe4pos.factor")
        m.dat <- subset(dat, apoe4pos.factor == "No")
        m.dat2 <- subset(dat2, apoe4pos.factor == "No")
        m.dat3 <- subset(dat3, apoe4pos.factor == "No")
      }
      
      if(grepl("sub.sex.female", m)){
        m.covs <- setdiff(m.covs, "sex.factor")
        m.dat <- subset(dat, sex.factor == "Female")
        m.dat2 <- subset(dat2, sex.factor == "Female")
        m.dat3 <- subset(dat3, sex.factor == "Female")
      }
      
            
      if(grepl("sub.sex.male", m)){
        m.covs <- setdiff(m.covs, "sex.factor")
        m.dat <- subset(dat, sex.factor == "Male")
        m.dat2 <- subset(dat2, sex.factor == "Male")
        m.dat3 <- subset(dat3, sex.factor == "Male")
      }

      cat(paste0("\n### Model: ", m.text, " \n"))
      
      htList[[m]][[vname]] <- 
        tryCatch(ModelPlus(dat = m.dat, 
                           predictor = my.pred, 
                           outcome = vname, 
                           covariates = m.covs, 
                           mod = m, 
                           show = TRUE)
                 , error= function(e) e)
      
      htList[[m2]][[vname]] <-
        tryCatch(ModelPlus(dat = m.dat2,
                           predictor = my.pred,
                           outcome = vname,
                           covariates = m.covs,
                           mod = m,
                           show = FALSE)
                 , error= function(e) e)
      
      htList[[m3]][[vname]] <-
        tryCatch(ModelPlus(dat = m.dat3,
                           predictor = my.pred,
                           outcome = vname,
                           covariates = m.covs,
                           mod = m,
                           show = FALSE)
                 , error= function(e) e)
    }
  }
  htList
}
```

```{r models}
models <- c(
  "main",
  "inter.dx",
  "sub.nc",
  "sub.mci",
  "inter.apoe",
  "sub.apoe.yes",
  "sub.apoe.no",
  "inter.sex",
  "sub.sex.female",
  "sub.sex.male"
)

models.label <- c(
  "Main Effect", 
  "Interaction: By Diagnosis", 
  "Subgroup: Normal",
  "Subgroup: MCI",
  "Interaction: By APOE4",
  "Subgroup: APOE4 Positive",
  "Subgroup: APOE4 Negative",
  "Interaction: By Sex",
  "Subgroup: Female",
  "Subgroup: Male"
)
```

```{r long.regression, results = 'asis', warning = FALSE, message = FALSE}
current.predictors.var <- predictors.var

long.regression.list <- vector("list", length(current.predictors.var))
names(long.regression.list) <- current.predictors.var

for (i in seq_along(current.predictors.var)) {
  pname = current.predictors.var[i]
  cat(paste0("\n# Longitudinal Analyses: ", pname, " as predictor", " {.tabset .tabset-fade .tabset-pills} \n"))
  long.regression.list[[pname]] <- my.section(
    my.pred = pname,
    my.outcomes = outcomes.var,
    my.covariates = covariates.var, 
    my.mod = models,
    my.mod.text = models.label
  )
}
```

# Summary Tables of Longitudinal Regression Results {.tabset .tabset-fade .tabset-pills}

```{r long-create-summary-table, message = FALSE, warning = FALSE}
options(scipen = 999)

d = matrix(data = "delete", ncol = 9)

for (pname in names(long.regression.list)) {
  for(m in names(long.regression.list[[pname]])) {
    for(vname in names(long.regression.list[[pname]][[m]])) {
      tmpList <- long.regression.list[[pname]][[m]][[vname]]
      if (any(grepl("message", names(long.regression.list[[pname]][[m]][[vname]])))) {
        newrow <- c(
          m,
          pname,
          vname,
          rep(NA, 6)
        )
      } else {
        tmpTbl <- tryCatch(
          tail(tmpList[["sumtable"]], 1), 
          error = function(e) e
        )
        newrow <- c(
          m,
          pname,
          vname,
          tmpList[["N"]],
          tmpTbl[1],
          tmpTbl["lci"],
          tmpTbl["uci"],
          tmpTbl[4],
          tmpList[["total.p"]]
        )
      }
      d <- rbind(d, newrow)
    }
  }
}

summary.all.df <- data.frame(d[-1, ], stringsAsFactors = FALSE)

colnames(summary.all.df) <- paste0("X", 1:9)

# colnames(summary.all.df) <- c("Model", "Predictor", "Outcome", "N", "Estimate", "95% LCI", "95% UCI", "p-Value", "Adj R2", "C-Index", "Total p-Value", "Dropped Variables")

# summary.all.df %<>%
#   tidyr::replace_na(
#     list(
#       X9 = "", 
#       X10 = ""
#     )
#   )

summary.all.df[, 5:9] <-
  lapply(
    summary.all.df[, 5:9], 
    as.numeric
  )

summary.all.df[, 5:9] <-
  lapply(
    summary.all.df[, 5:9], 
    function(x) prettyNum(x)
  )

# summary.all.df$X9 <- round(as.numeric(summary.all.df$X9), 4)

###

# summary.final.df <- summary.all.df

summary.all.long.df <- summary.all.df

summary.final.df <- cbind(
  summary.all.df[grep("sens", summary.all.df$X1, invert = T), ], 
  summary.all.df[grep("sens.outlier", summary.all.df$X1), ]
)

summary.final.df <- cbind(
  summary.final.df,
  summary.all.df[grep("sens.cvd.afib", summary.all.df$X1), ]
)

summary.final.df <- summary.final.df[, -c(10:12, 19:21)]

summary.final.df$X1 <- factor(summary.final.df$X1, levels = unique(summary.final.df$X1))
summary.final.df$X2 <- factor(summary.final.df$X2, levels = unique(summary.final.df$X2))
summary.final.df$X3 <- factor(summary.final.df$X3, levels = unique(summary.final.df$X3))

summary.formatted <- formattable(
  summary.final.df, 
  list(
    `X8` = format_p,
    `X9` = format_p,
    `X8.1` = format_p,
    `X9.1` = format_p,
    `X8.2` = format_p,
    `X9.2` = format_p
  )
)

sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      # th(rowspan = 2, 'Model'),
      th(rowspan = 2, 'Predictor'),
      th(rowspan = 2, 'Outcome'),
      th(colspan = 6, 'Primary Analyses'),
      th(colspan = 6, 'Sensitivity Analyses: Excluding Outliers'),
      th(colspan = 6, 'Sensitivity Analyses: Excluding CVD/AFib')
    ),
    tr(
      lapply(rep(c("N", "Estimate", "95% LCI",  "95% UCI", "p-Value", "Total p-Value"), 3), th)
    )
  )
))
```

## Main Effect

```{r long-summary-table-main, warning = FALSE, message = FALSE}
as.datatable(
  summary.formatted[summary.formatted$X1 == models[1], -1],
  rownames = FALSE,
  container = sketch,
  extensions = c('Buttons', 'FixedColumns'),
  options = list(
    dom = 'Btip',
    pageLength = length(outcomes.var),
    buttons = c('copy', 'csv'),
    scrollX = TRUE,
    fixedColumns = list(leftColumns = 2)
  )
)
```

## Interaction: By Diagnosis

```{r long-summary-table-inderdx, warning = FALSE, message = FALSE}
as.datatable(
  summary.formatted[summary.formatted$X1 == models[2], -1],
  rownames = FALSE,
  container = sketch,
  extensions = c('Buttons', 'FixedColumns'),
  options = list(
    dom = 'Btip',
    pageLength = length(outcomes.var),
    buttons = c('copy', 'csv'),
    scrollX = TRUE,
    fixedColumns = list(leftColumns = 2)
  )
)
```

## Subgroup: Normal

```{r long-summary-table-subnc, warning = FALSE, message = FALSE}
as.datatable(
  summary.formatted[summary.formatted$X1 == models[3], -1],
  rownames = FALSE,
  container = sketch,
  extensions = c('Buttons', 'FixedColumns'),
  options = list(
    dom = 'Btip',
    pageLength = length(outcomes.var),
    buttons = c('copy', 'csv'),
    scrollX = TRUE,
    fixedColumns = list(leftColumns = 2)
  )
)
```

## Subgroup: MCI

```{r long-summary-table-submci, warning = FALSE, message = FALSE}
as.datatable(
  summary.formatted[summary.formatted$X1 == models[4], -1],
  rownames = FALSE,
  container = sketch,
  extensions = c('Buttons', 'FixedColumns'),
  options = list(
    dom = 'Btip',
    pageLength = length(outcomes.var),
    buttons = c('copy', 'csv'),
    scrollX = TRUE,
    fixedColumns = list(leftColumns = 2)
  )
)
```

## Interaction: By APOE4

```{r long-summary-table-interapoe, warning = FALSE, message = FALSE}
as.datatable(
  summary.formatted[summary.formatted$X1 == models[5], -1],
  rownames = FALSE,
  container = sketch,
  extensions = c('Buttons', 'FixedColumns'),
  options = list(
    dom = 'Btip',
    pageLength = length(outcomes.var),
    buttons = c('copy', 'csv'),
    scrollX = TRUE,
    fixedColumns = list(leftColumns = 2)
  )
)
```

## Subgroup: APOE4 Positive

```{r long-summary-table-subyes, warning = FALSE, message = FALSE}
as.datatable(
  summary.formatted[summary.formatted$X1 == models[6], -1],
  rownames = FALSE,
  container = sketch,
  extensions = c('Buttons', 'FixedColumns'),
  options = list(
    dom = 'Btip',
    pageLength = length(outcomes.var),
    buttons = c('copy', 'csv'),
    scrollX = TRUE,
    fixedColumns = list(leftColumns = 2)
  )
)
```

## Subgroup: APOE4 Negative

```{r long-summary-table-subno, warning = FALSE, message = FALSE}
as.datatable(
  summary.formatted[summary.formatted$X1 == models[7], -1],
  rownames = FALSE,
  container = sketch,
  extensions = c('Buttons', 'FixedColumns'),
  options = list(
    dom = 'Btip',
    pageLength = length(outcomes.var),
    buttons = c('copy', 'csv'),
    scrollX = TRUE,
    fixedColumns = list(leftColumns = 2)
  )
)
```

# Session Info

```{r}
sessionInfo()
```

